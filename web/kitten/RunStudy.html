<!--
    Collector (Garcia, Kornell, Kerr, Blake & Haffey)
    A program for running experiments on the web
    Copyright 2012-2016 Mikey Garcia & Nate Kornell


    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License version 3 as published by
    the Free Software Foundation.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>

		Kitten release (2019-20) author: Dr. Anthony Haffey (a.haffey@reading.ac.uk)
-->
<head>
  <link rel="shortcut icon" type="image/x-icon" href="../logos/collector.ico.png" />
	<meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="shortcut icon" type="image/x-icon" href="../logos/collector.ico.png" />
</head>

<script src="../../eel.js"></script>

<script src="../libraries/jquery-3.3.1.min.js"></script>
<script src="../libraries/tweetnacl.js"></script>
<script src="../libraries/tweetnacl-utils.js"></script>
<script src="../libraries/crypto-js.min.js"></script>
<script src="../libraries/papaparse.4.3.6.min.js"></script>
<script src="../libraries/jquery-3.3.1.min.js"></script>
<script src="../libraries/popper.min.js"></script>
<script src="../libraries/bootbox.4.4.0.min.js"></script>

<link rel="stylesheet" href="../libraries/bootstrapCollector.css">
<script src="../libraries/bootstrap.4.0.min.js"></script>

<script src="Code/InitiateCollector.js"></script>
<script src="Code/OnlineTriggers.js"></script>
<script src="Code/CollectorEncrypt.js"></script>
<script src="Code/BrowserCheck.js"></script>

<div id="welcome_html"></div>
<script>
$("#welcome_html").load("Welcome.html");
</script>


<style>
.trial_iframe{
  visibility:hidden;
	overflow:hidden;
	width:0%;
	height:0%;
	margin-left: auto;
	margin-right: auto;
}

#experiment_div{
	display: none;
	width  : 100%;
	margin : auto;
}

#download_json{
	color:green;
}
#post_welcome{
	display:none;
}
</style>


<div id="post_welcome">
	<div class="progress" style="height: 1px; position:fixed;">
		<div id="experiment_progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div>
	</div>

	<div id="loading_div">Preparing encryption of data</div>
	<div id="stim_progress" class="progress">
		<div id="stim_listing" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div>
	</div>
	<div id="beginning_checks" style="display:none">
		External keyboards generally do not work. Please do not try to use an external keyboard.<br><br>
		Sometimes it may take a page a while to load. Please wait, and <b>DO NOT REFRESH THE PAGE</b>.<br><br>
		Please click "Understood" to show that you have understood these instructions. <br><br>
		<input type="button" value="Understood" id="proc_button">
	</div>
	<div id = "calibrate_div"></div>
	<div id="experiment_div" scrolling="no"></div>
</div>
<div id="participant_country"></div>
<script src="iframe_library.js"></script>
<script src="TrialFunctions.js"></script>


<!-- will look into making the following libraries local in the future -->

<script src="../libraries/ammap.js"></script>
<script src="../libraries/worldLow.js"></script>
<script src="../libraries/ammap_theme_light.js"></script>



<input type="hidden" id="completion_code" name="completion_code"/>
<input type="hidden" id="prehashed_code" name="prehashed_code"/>
<script>
exp_json = {}; //this will get updated

/////////////
// Objects //
/////////////

online_data_obj = {
  finished_and_stored: false,
  saves_started:0,
  saves_ended:0,
  save_queue:[],
  run_save:function(){
    var this_save = online_data_obj.save_queue.pop();
    this_save();
    if(online_data_obj.save_queue.length > 0){         //keep going until all saves done.
      online_data_obj.run_save();
    }
  },
  save_queue_add:function(save_queue_item){
    online_data_obj.save_queue.push(save_queue_item);
    if(online_data_obj.save_queue.length == 1){        //need to initiate run_save as it stopped before you added this item
      online_data_obj.run_save();
    }
  }
}

//////////////
// Pipeline //
//////////////

Study = {
  ////////////////////////////
  // Pipeline functionality //
  ////////////////////////////

  get_vars        : {},
  resume          : false,
  pipeline        : ["get_gets",
                     "start_restart",
                     "start_study",
                     "select_condition",
                     "full_screen",
                     "create_exp_json_variables",
                     "parse_sheets",
                     "parse_current_proc",
                     "clean_trialtypes",
                     "insert_start",
                     "shuffle_start_exp",
                     "buffer_trials",
                     "process_welcome"],
  // start functions are the functions required when NOT resuming
  start_functions : ["create_exp_json_variables",
                      "parse_sheets",
                      "parse_current_proc",
                      "clean_trialtypes",
                      "insert_start",
                      "shuffle_start_exp"],
  activate_pipe   : function(){
    var this_function = Study.pipeline.shift();
    if(Study.resume == false | Study.start_functions.indexOf(this_function) == -1){
      if(typeof(this_function) !== "undefined"){
        window[this_function]();
      }
    } else {
      Study.activate_pipe();
    }
  },

  /////////////////////
  // Trial functions //
  /////////////////////
  finish_trial: function(trial_no,post_no){

    trial_end_ms = (new Date()).getTime();
    trial_inputs = {};

    $("#experiment_progress").css("width",(100 * exp_json.trial_no/(exp_json.parsed_proc.length-1))+"%");

    for(var i = 0; i < exp_json.inputs.length; i++){
      if($("input[name='"+exp_json.inputs[i].name+"']:checked").length == 0){
        trial_inputs[exp_json.inputs[i].name]=exp_json.inputs[i].value;
      } else {
        if(exp_json.inputs[i].checked){
          trial_inputs[exp_json.inputs[i].name]=exp_json.inputs[i].value;
        }
      }
    }

    this_proc = exp_json.parsed_proc[exp_json.trial_no];
    if(typeof(exp_json.parsed_stim[this_proc.item]) == "undefined"){
      this_stim = {};
    } else {
      this_stim = exp_json.parsed_stim[this_proc.item];
    }

    if(this_stim == null){
      this_stim = {};
    }

    var objs = [exp_json.this_trial, trial_inputs, this_proc, this_stim],
    response_data =  objs.reduce(function (r, o) {
        Object.keys(o).forEach(function (k) {
            r[k] = o[k];
        });
        return r;
    }, {});

    response_data["post_"+exp_json.post_no+"_trial_end_ms"]   = trial_end_ms;
    response_data["post_"+exp_json.post_no+"_rt_ms"] = trial_end_ms - response_data["post_"+exp_json.post_no+"_trial_start_ms"]
    response_data["post_"+exp_json.post_no+"_trial_end_date"] = new Date(parseInt(trial_end_ms, 10)).toString('MM/dd/yy HH:mm:ss');
    exp_json.this_trial = response_data;
    response_data["participant_browser"] = participant_browser;

    $("#trial"+exp_json.trial_no).contents().children().find("iframe").length;
    if($("#trial"+exp_json.trial_no).contents().children().find("iframe").length == exp_json.post_no + 1){
      //$(".trial_iframe").hide();
      $("#trial"+exp_json.trial_no).remove(); // destroy iframe for previous trial.
      exp_json.responses.push(exp_json.this_trial);
      if(exp_json.trial_no == exp_json.parsed_proc.length - 1){
        final_trial();
      } else {
        exp_json.this_trial = {};
        exp_json.trial_no = parseFloat(exp_json.trial_no) +1;
        exp_json.post_no = 0;
        setTimeout(function(){
          var this_index = parseFloat(exp_json.trial_no) + parseFloat(exp_json.this_condition.buffer) - 1;
          write_trial_iframe(this_index);
        });
        Study.start_post();
      }
    } else {
      exp_json.post_no++;
      var start_time = (new Date()).getTime();
      exp_json.this_trial["post_"+exp_json.post_no+"_trial_start_ms"]   = (new Date()).getTime();
      exp_json.this_trial["post_"+exp_json.post_no+"_trial_start_date"] = new Date(parseInt(start_time, 10)).toString('MM/dd/yy HH:mm:ss');

      // and then hide previous post and show next post within trial.
      $("#trial"+exp_json.trial_no).contents().children().find("iframe").hide();
      Study.start_post();
    }
    
    switch(Study.get_vars.platform){
      case "localhost":
        eel.save_data(Study.get_vars.location,
                      $("#participant_code").val(),
                      $("#completion_code").val(),
                      Papa.unparse(complete_csv(exp_json.responses),{
                        quotes: false, //or array of booleans
                        header: true,
                        skipEmptyLines: true, //or 'greedy',
                      }));                    //the data
        break;
      case "github":
        online_data_obj.saves_started ++;
        online_data_obj.save_queue_add(
          function(){
            online_save(Study.get_vars.location,
                      $("#participant_code").val(),
                      $("#completion_code").val(),
                      $("#prehashed_code").val(),  
                      JSON.stringify(encrypt(exp_json.public_key,    //the public key
                      JSON.stringify(exp_json.responses))),          //the data
            exp_json.save_script,
            function(){
              online_data_obj.saves_ended ++;
            });
          }
        );
        break
      case "preview":
        //do nothing - you are not meant to be saving;
        break;
    }
  },

  generate_trial: function(trial_no,post_no){
    if(typeof(exp_json.parsed_proc[trial_no]) == "undefined"){
			return false;
		}

		post_no = post_no == 0 ? "" : "post "+post_no+" ";
		this_proc 	   = exp_json.parsed_proc[trial_no];
		this_trialtype = exp_json.trialtypes[this_proc[post_no+"trial type"]];

		//look through all variables and replace with the value

		this_trialtype =  "<scr" + "ipt> Trial = {}; Trial.trial_no = '"+trial_no+"'; Trial.post_no ='"+post_no+"' </scr" + "ipt>" + "<scr" + "ipt src = 'TrialFunctions.js' ></scr" + "ipt>" + this_trialtype ; //; trial_script +


		this_trialtype = this_trialtype.replace("[trial_no]",trial_no);
		this_trialtype = this_trialtype.replace("[post_no]",post_no);

		if(this_proc["item"].toString() !== "0"){

      this_stim = exp_json.parsed_stim[this_proc["item"]];
      variable_list = Object.keys(this_proc).concat(Object.keys(this_stim));
		} else {
			variable_list = Object.keys(this_proc);
		}
		variable_list = variable_list.filter(String);

		//list everything between {{ and }} and transform them into lowercase
		split_trialtype = this_trialtype.split("{{");
		split_trialtype = split_trialtype.map(function(split_part){
			if(split_part.indexOf("}}") !== -1){
				more_split_part = split_part.split("}}");
				more_split_part[0] = more_split_part[0].toLowerCase();
				split_part = more_split_part.join("}}");
			}
			return split_part;
		});
		this_trialtype = split_trialtype.join("{{");

		variable_list.forEach(function(variable,this_index){
			if(typeof(this_proc[variable]) !== "undefined"){
				variable_val = this_proc[variable];
			} else if(typeof(this_stim) !== "undefined" && typeof(this_stim[variable]) !== "undefined"){
				variable_val = this_stim[variable];
			} else {
				if(typeof(this_stim) !== "undefined"){
          console.dir("Not sure whether this means there's a bug or not");
          //bootbox.alert("serious bug, please contact researcher about missing variable");
        }
			}
			this_trialtype = this_trialtype.replaceAll("{{" + variable + "}}", variable_val);
		});
    this_trialtype = this_trialtype.replaceAll("www.dropbox","dl.dropbox"); // in case user forgets
		return this_trialtype;
	},

  start_post: function(){

		if(typeof(exp_json.responses[exp_json.trial_no]) == "undefined"){
			exp_json.responses[exp_json.trial_no] = {};
		}
		exp_json.this_trial["post_"+exp_json.post_no+"_trial_start_ms"] = (new Date()).getTime();
		if($("#trial"+exp_json.trial_no).contents().children().length > 0){
			var this_post_iframe = $("#trial"+exp_json.trial_no).contents().children().find("iframe").filter(function(element){
 				return element == exp_json.post_no;
			})[0];
			this_post_iframe.style["visibility"] = "visible";

			$("#trial"+exp_json.trial_no).css("display","inline-block");
			$("#trial"+exp_json.trial_no).css("width", "100%");
			$("#trial"+exp_json.trial_no).css("height", "100%");
			$("#trial"+exp_json.trial_no).css("visibility","visible");
      $("#trial"+exp_json.trial_no).contents().find("#post"+exp_json.post_no).contents().find("#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz").focus(); //or anything that no-one would accidentally create.

			//detect if max time exists and start timer
			if(exp_json.post_no == 0){
				var post_val = "";
			} else {
				post_val = "post "+exp_json.post_no + " ";
			}
			if(typeof(exp_json.parsed_proc[exp_json.trial_no][post_val + "max time"]) == "undefined"){
				max_time = "user";
			} else {
				var max_time = exp_json.parsed_proc[exp_json.trial_no][post_val + "max time"];
			}
			if(max_time !== "" & max_time.toLowerCase() !== "user"){
				var this_trial_no = exp_json.trial_no;
				var this_post_no  = exp_json.post_no;
				setTimeout(function(){
					if(this_trial_no == exp_json.trial_no && this_post_no == exp_json.post_no){
						Study.finish_trial(this_trial_no,this_post_no);
					}
				},parseFloat(max_time));
			}
      participant_backup();

			//deal with any Trial.set_timer or Trial.time_elapsed functions here
			//var this_timeout = exp_json.time_outs.filter(row => row.trial_no == parseFloat(exp_json.trial_no));

      var this_timeout = exp_json.time_outs.filter(function(row){
        return row.trial_no == parseFloat(exp_json.trial_no);
      });

			if(this_timeout.length !== 0){ //should have  && this_timeout.length == 1 - need to deal with when there are multiple
				this_timeout.forEach(function(spec_timeout){
          setTimeout(function(){
            spec_timeout.this_func();
          }, spec_timeout.duration);
        });
			} else {
				//no timers on this trial?
			}
		}
	}
}


///////////////
// Functions //
///////////////

function buffer_trials(){
	var this_buffer = exp_json.this_condition.buffer;
	var trial_no    = exp_json.trial_no;
  for(var index = trial_no; index < trial_no + this_buffer; index++){
		write_trial_iframe(index);
	};
	if(trial_no >= exp_json.parsed_proc.length){
		$("#experiment_div").html("<h1>You have already completed this experiment</h1>");
	}
  Study.activate_pipe();
}

function cancelFullscreen(){
	if (document.cancelFullScreen) {
		document.cancelFullScreen();
	} else if (document.mozCancelFullScreen) {
		document.mozCancelFullScreen();
	} else if (document.webkitCancelFullScreen) {
		document.webkitCancelFullScreen();
	}
}

function clean_this_condition(this_cond){
	this_cond.download 				= clean_var(this_cond.download,"on");
	this_cond.participant_id 	= clean_var(this_cond.participant_id,"on");
	if(typeof(this_cond.buffer) == "undefined"){
		this_cond.buffer = 5;
	}
	return this_cond;
}

function clean_trialtypes(){
  exp_json.parsed_proc.forEach(function(row,row_index){
    //identify trial type columns
    var tt_cols = Object.keys(row).filter(this_key => this_key.indexOf("trial type") !== -1);
    tt_cols.forEach(function(tt_col){
      exp_json.parsed_proc[row_index][tt_col] = exp_json.parsed_proc[row_index][tt_col].toLowerCase();
    });
  });
  Study.activate_pipe();
}

function clean_var(this_variable,default_value){
	if(typeof(this_variable) == "undefined"){
		this_variable = default_value;
	} else {
		this_variable = this_variable.toLowerCase();
	}
	return this_variable;
}


function create_exp_json_variables(){
	exp_json.this_trial = {};
	exp_json.uninitiated_stims = [];
	exp_json.uninitiated_stims_sum = 0;
	exp_json.initiated_stims = 0;
	exp_json.time_outs = [];
	exp_json.inputs = [];
	exp_json.progress_bar_visible = true; //not doing anything at the moment
	exp_json.trial_no = 0;
	exp_json.post_no  = 0;
	exp_json.responses = [];

  Study.activate_pipe();
}

function final_trial(){
  switch(Study.get_vars.platform){
    case "server": //this should be changed to preview if you do not want data saved!
      $("#experiment_div").html("<h3 class='text-primary'>Please do not close this window until it has been confirmed that the researcher has been e-mailed your data (or you have downloaded the data yourself that you will e-mail the researcher). If you do not get a prompt to do this within 30 seconds, press CTRL-S and you should be able to directly download your data.</h3>");


      $.post("emailData.php",{
        all_data   : JSON.stringify(exp_json),
      },function(returned_data){
        message_data = returned_data.split(" encrypted data = ");
        if(message_data.length == 1){
          //retrieve researcher e-mail address
          precrypted_data(exp_json,"Problem encrypting: <b>"+ message_data +"</b>, we'll try again every 10 seconds, but in case it fails, please download and e-mail this file. What do you want to save this file as? (you will get this message each time we fail to e-mail your data to the researcher)");
          setTimeout(function(){
            final_trial();
          },10000);
        } else {
            $("#participant_country").show();
            $("#participant_country").load("ParticipantCountry.html");

          encrypted_data = message_data[1];

          if(typeof(exp_json.this_condition.end_message) !== "undefined" && exp_json.this_condition.end_message !== ""){
            $("#experiment_div").html("<h3 class='text-primary'>"+exp_json.this_condition.end_message+"</h3>");
          } else {
            $("#experiment_div").html("");
          }
          $("#experiment_div").append("<div id='download_div'></div>");

          if(download_at_end == "on"){
            $("#download_div").html("<h1 class='text-primary'>" + message_data[0] + " <br><br> You can download the encrypted version of your data <span id='encrypt_click' class='text-success'>here</span> <br><br>or an unencrypted version <span id='raw_click' class='text-success'>here</span></h1>");

              $("#encrypt_click").on("click",function(){
                bootbox.prompt({
                  title:"What do you want to save this file as?",
                  value:$("#participant_code").val()+"_encrypted.txt",
                  callback:function(result){
                    var blob = new Blob([encrypted_data], {type: 'text/csv'});
                    if(window.navigator.msSaveOrOpenBlob) {
                      window.navigator.msSaveBlob(blob, result);
                    }
                    else{
                      var elem = window.document.createElement('a');
                      elem.href = window.URL.createObjectURL(blob);
                      elem.download = result;
                      document.body.appendChild(elem);
                      elem.click();
                      document.body.removeChild(elem);
                    }
                  }
                });
              });
              $("#raw_click").on("click",function(){
                precrypted_data(exp_json,"What do you want to save this file as?");
              });
          } else if(download_at_end == "off") {
            // do nothing
          } else {
            bootbox.alert("It's unclear whether the researcher wants you to be able to download your data or not");
          }
          online_data_obj.finished_and_stored = true;
        }
      });
      break;
    case "github":
      $("#experiment_div").html("<h1 class='text-danger'>" +
                                  "Please wait while we confirm that all your data has been saved" +
                                "</h1>" +
                                '<div class="progress">'+
                                  '<div id="google_progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%">' +
                                  '</div>' +
                                '</div>');
      function online_save_check(){
        setTimeout(function(){
          if(online_data_obj.saves_started == online_data_obj.saves_ended){
            $("#google_progress").css("width","100%");
            setTimeout(function(){
              if(exp_json.this_condition.download_at_end !== "off"){
                var download_at_end_html = " If you'd like to download your raw data <span id='download_json'>click here</span></h1>";
              } else {
                var download_at_end_html = "";
              }
              $("#experiment_div").html("<h1>Thank you for participating." + download_at_end_html);
              $("#download_json").on("click",function(){
                precrypted_data(exp_json,"What do you want to save this file as?");
              });
              $("#participant_country").show();
              $("#participant_country").load("ParticipantCountry.html");
              window.localStorage.removeItem("exp_json");
              window.localStorage.removeItem("username");
              window.localStorage.removeItem("completion_code");
              window.localStorage.removeItem("prehashed_code");
            },1000);
          } else {
            var google_prog_perc = (100*online_data_obj.saves_ended/online_data_obj.saves_started) + "%";
            $("#google_progress").css("width",google_prog_perc);
            online_save_check();
          }
        },1000);
      }
      online_save_check();
      break;
    case "localhost":
    case "preview":
      if(exp_json.this_condition.download_at_end !== "off"){
        download_message = "You can download the data by clicking <b><span id='download_json'>here</span></b>.";
      } else {
        download_message = "";
      }
      $("#experiment_div").html("<h1>You have finished. " + download_message + "</h1>");
      $("#download_json").on("click",function(){
        precrypted_data(exp_json,"What do you want to save this file as?");
      });
      window.localStorage.removeItem("exp_json");
      window.localStorage.removeItem("username");
      window.localStorage.removeItem("completion_code");
      window.localStorage.removeItem("prehashed_code");
      break
  }
}

function full_screen(){
  if(typeof(exp_json.this_condition.fullscreen) !== "undefined"){
    if(exp_json.this_condition.fullscreen == "on"){
      var elem = $(document.body);
      bootbox.confirm("The researcher would like to run this in full screen, are you okay with that?",function(response){
        if(response){
          requestFullScreen(document.documentElement);
        }
      });
    }
  }
  Study.activate_pipe();
}

//solution to retrieve get values from url by weltraumpirat at https://stackoverflow.com/questions/5448545/how-to-retrieve-get-parameters-from-javascript/5448635#5448635
function get_gets() {
  function transformToAssocArray( prmstr ) {
    var params = {};
    var prmarr = prmstr.split("&");
    for ( var i = 0; i < prmarr.length; i++) {
      var tmparr = prmarr[i].split("=");
      params[tmparr[0]] = tmparr[1];
    }
    return params;
  }
  var prmstr = window.location.search.substr(1);
  Study.get_vars = prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};

  // maybe the following is left over from the simulator?
  if(typeof(Study.get_vars["name"]) !== "undefined"){
    exp_condition = Study.get_vars["name"];
  } else {
    exp_condition = "";
  }
  if(Study.get_vars.platform == "preview"){
    bootbox.alert("You are in <b>Preview</b> mode. This means that you will <b>NOT</b> be saving any data. If this is not what you want, go back to the study editor, click <em>run</em> again, and click on 'local' or 'online' instead of 'preview'");
  }
  Study.activate_pipe();
}

function insert_start(){
  
  // skip this if in preview mode
  if(Study.get_vars.platform !== "preview"){

    // update the procedure to have a general warning
    var this_proc  = exp_json.parsed_proc;

    var this_proc_start = {
      item:0,
      max_time:"",
      shuffle_1:"off",
      text:"",
      "trial type":"start_experiment"
    }
    this_proc = this_proc.unshift(this_proc_start);

    // update trialtypes to have a "start" trial
    ////////////////////////////////////////////
    if(typeof(exp_json.trialtypes) !== "undefined"){
      exp_json.trialtypes.start_experiment =
        "<h1>Before starting</h1>" +
        "<div>Please be careful about what details you give. If you feel that any inappropriate details are being asked, please contact whoever asked you to participate.</div>" +
        "<button class='btn btn-primary' onclick='Trial.submit()'>Start</button>";
    }  
  }
  Study.activate_pipe();
}

function parse_sheets(){
  var proc_sheet_name = exp_json.this_condition.procedure
                                .toLowerCase()
                                .replace(".csv","") + ".csv";
  var stim_sheet_name = exp_json.this_condition.stimuli
                                .toLowerCase()
                                .replace(".csv","") + ".csv"
  proc_stim_loaded = [];
  
  switch(Study.get_vars.platform){
    case "localhost":
    case "preview":
    case "github":
      var proc_url = "../User/Experiments/" + 
                     Study.get_vars.location +
                     "/" + proc_sheet_name;
      $.get(proc_url,function(proc_sheet_content){
        exp_json.parsed_proc = collectorPapaParsed(proc_sheet_content);
        proc_stim_loaded[1] = "procedure";
        if(proc_stim_loaded.join("-") == "stimuli-procedure"){
          Study.activate_pipe();
        }
      });
      var stim_url = "../User/Experiments/"  + 
                     Study.get_vars.location +
                     "/" +  stim_sheet_name;
      $.get(stim_url,function(stim_sheet_content){
        exp_json.parsed_stim = [null,null].concat(collectorPapaParsed(stim_sheet_content)); 
        proc_stim_loaded[0] = "stimuli";
        if(proc_stim_loaded.join("-") == "stimuli-procedure"){
          Study.activate_pipe();
        }
      });
      break;
    case "dropbox":
    case "server":
      proc_stim_loaded[1] = "procedure";
      exp_json.parsed_proc = collectorPapaParsed(exp_json.all_procs[proc_sheet_name]);
      if(proc_stim_loaded.join("-") == "stimuli-procedure"){
        Study.activate_pipe();
      }
      exp_json.parsed_stim = collectorPapaParsed(exp_json.all_stims[stim_sheet_name]);
      proc_stim_loaded[0] = "stimuli";
      if(proc_stim_loaded.join("-") == "stimuli-procedure"){
        Study.activate_pipe();
      }      
      break;
  }
}

function parse_current_proc(){
  function proc_apply_repeats(){
  	var this_proc = exp_json.parsed_proc;
  	repeat_cols = ["weight","frequency","freq","repeat"];

  	// warn researcher if multiple repeat columns
  	///////////////////////////////////////////////

  	var repeat_cols_pres = [];
  	Object.keys(this_proc[0]).forEach(function(header){
  		if(repeat_cols.indexOf(header) !== -1){
  			repeat_cols_pres.push(header);
  		}
  	});

  	if(repeat_cols_pres.length > 1){
  		bootbox.alert("There are multiple columns that do the same thing, please only use one of them: " + repeat_cols_pres.join(" , ") + ". If you are a participant, please contact the researcher and tell them about this problem.");
  	}

  	// fill in repeats
  	////////////////////

  	var filled_proc = [];
  	for(var i = 0; i < this_proc.length; i++){
  		var this_row = this_proc[i];

  		this_row.repeat = typeof(this_row.weight)			!== "undefined" ? this_row.weight :
  											typeof(this_row.frequency)	!== "undefined" ? this_row.frequency 	:
  											typeof(this_row.freq)				!== "undefined" ? this_row.freq 			:
  											typeof(this_row.repeat)			!== "undefined" ? this_row.repeat 		: "";

  		if(typeof(this_row.repeat) !== "undefined" && this_row.repeat !== ""){
  			for(var k = 0; k < this_row.repeat; k ++){
  				filled_proc.push(this_row);
  			}
  		} else {
  			filled_proc.push(this_row);
  		}
  	}
  	exp_json.parsed_proc = filled_proc;
  }
  function proc_fill_items(){
  	var this_proc   = exp_json.parsed_proc;
  	var filled_proc = [];

  	for(var j = 0; j < this_proc.length; j++){
  		var row = this_proc[j];
  		if(row.item.indexOf(" to ") == -1 && row.item.indexOf(",") == -1){
  			filled_proc.push(row);
  		} else {
  			// split by commas
  			///////////////////
  			var items_array = row.item.split(",");
  			var complete_items_array = [];
  			items_array.forEach(function(item){
  				if(item.indexOf(" to ") == -1){
  					complete_items_array.push(item);
  				} else {
  					// split by colons
  					///////////////////
  					item_start_end = item.split(" to ");
  					if(item_start_end.length > 2){
  						bootbox.alert("There is a problem with the procedure sheet - see the row in which the item column value is " +row.item + ", there is more than 1 ':' which is not allowed. If you are not the researcher, can you please send this message to them.");
  					}
  					var item_start = parseFloat(item_start_end[0]);
  					var item_end   = parseFloat(item_start_end[1]) +1;
  					for(var this_item = item_start ; this_item < item_end ; this_item++){
  						complete_items_array.push(this_item);
  					}
  				}
  			});

  			// for each item, push a row
  			/////////////////////////////
  			complete_items_array.forEach(function(item){

  				// check repetition column
  				///////////////////////////
  				var this_row_with_this_item  = JSON.parse(JSON.stringify(row));
  				this_row_with_this_item.item = item;
  				filled_proc.push(this_row_with_this_item);
  			});
  		}
  	};
  	exp_json.parsed_proc = filled_proc;
  }
	exp_json.parsed_proc = exp_json.parsed_proc.filter( function(row){
    return Object.keys(row).every(function(x) { return row[x]===''||row[x]===null;}) === false;
  });
	proc_fill_items();
	proc_apply_repeats();
  Study.activate_pipe();
}

function participant_backup(){
  window.localStorage.setItem("exp_json",JSON.stringify(exp_json));
  window.localStorage.setItem("username",$("#participant_code").val());
}

function post_welcome(participant_code,id_error){
  var completion_code = Math.random().toString(36).substr(2, 10);
  window.localStorage.setItem("completion_code",completion_code);
  $("#completion_code").val(completion_code);
  var prehashed_code = Math.random().toString(36).substr(2, 10);
  window.localStorage.setItem("prehashed_code",prehashed_code);
  $("#prehashed_code").val(prehashed_code);
  switch(Study.get_vars.platform){
    case "server":
      $.post("PostWelcome.php",{
        participant_code : participant_code,
        location: exp_json.location
      },function(returned_data){
        post_welcome_data(returned_data);
      });
      break;
    case "github":
    case "localhost":
    case "preview":
      id_error = "skip";
      post_welcome_data("blank");
      break;

  }
}

function post_welcome_data(returned_data){
  if(returned_data == "blank"){
    id_error = "skip";
  }

  if( returned_data == "blank" | //lazy solution for now.
      returned_data.indexOf("error") !== -1){
    if(id_error == "skip"){
      $("#welcome_div").hide();
      $("#post_welcome").show();
      $("#experiment_div").show();
      full_screen();
    } else if(id_error == "random"){

      //generate new random code
      var this_code = Math.random().toString(36).substr(2, 16);
      post_welcome(this_code,"random");

    } else if(id_error == false){
      bootbox.confirm(returned_data,function(response){
        if(response){ 																		//i.e. chosen to proceed with id despite the warning
          $("#welcome_div").hide();
          $("#post_welcome").show();
          $("#experiment_div").show();
          full_screen();
        }
      });
    }
  }
}

function precrypted_data(decrypted_data,message){

  responses_csv = decrypted_data.responses;
  response_headers = [];
  responses_csv.forEach(function(row){
    Object.keys(row).forEach(function(item){
      if(response_headers.indexOf(item) == -1){
        response_headers.push(item);
      };
    });
  });
  this_condition    = decrypted_data.this_condition;

  condition_headers = Object.keys(this_condition).filter(function(item){
    return item !== "_empty_";
  });

  //condition_headers = Object.keys(this_condition).filter(item => item !== "_empty_");
  table_headers			= response_headers.concat(condition_headers);
  downloadable_csv = [table_headers];
  responses_csv.forEach(function(row,row_no){
    downloadable_csv.push([]);
    table_headers.forEach(function(item,item_no){
      if(typeof(row[item]) !== "undefined"){
        downloadable_csv[row_no+1][item_no] = row[item];
      } else if (condition_headers.indexOf(item) !== -1){
        downloadable_csv[row_no+1][item_no] = this_condition[item];
      } else {
        downloadable_csv[row_no+1][item_no] = "";
      }
    });
  });

  bootbox.prompt({
    title:message,
    value:$("#participant_code").val()+".csv",
    callback:function(result){
      if(result !== null){
        save_csv(result,Papa.unparse(downloadable_csv));
      }
    }
  });
}

function process_welcome(){
  if(document.getElementById("loading_exp_json") !== null) {
    // skip participant id? (and thus start_message)
		////////////////////////////////////////////////
		pp_id_setting = exp_json.this_condition.participant_id;

		if(pp_id_setting == "off"){																// put in a participant ID that is clearly not unique (e.g. "notUnique").
			$("#participant_code").val("notUnique");
			post_welcome("notUnique","skip"); 											//"skip" means that it will automatically accept non unique ids
		} else if(pp_id_setting == "random"){
      var this_code = Math.random().toString(36).substr(2, 16)
			$("#participant_code").val(this_code);
      post_welcome(this_code,"random");
		} else if(pp_id_setting  == "on"){
			$("#loading_exp_json").fadeOut(500);
			$("#researcher_message").fadeIn(2000);
			$("#participant_id_div").show(1000);
		}	else {
			bootbox.alert("It's not clear if the researcher wants you to give them a user id - please contact them before proceeding.");
		}

		if(exp_json.this_condition.start_message !== ""){
			$("#researcher_message").html(exp_json.this_condition.start_message);
		} else {
			def_start_msg = "<h1 class='text-primary'> Collector</h1>"+
											"<br><br>" +
											"<h4>It's very important to read the following before starting!</h1>" +
											"<div class='text-danger'>If you complete multiple Collector experiments at the same time, your completion codes may be messed up. Please do not do this!</div>" +
											"<br>" +
											"<div class='text-danger'>If you participate in this experiment, your progress in it will be stored on your local machine to avoid you losing your progress if the window or tab closes or freezes. This data will be cleared from your computer once you have completed the task. <b>However, if you do not want this website to store your progress on your computer, DO NOT PROCEED.</b></div>"+
											"<br>" +
											"<div class='text-danger'>If the experiment freezes, try pressing <b>CTRL-S</b> to save your data so far. </div>";
			$("#researcher_message").html(def_start_msg);
		}
	}
}

function requestFullScreen(element) {
    // Supports most browsers and their versions.
    var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;

    if (requestMethod) { // Native full screen.
        requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
        var wscript = new ActiveXObject("WScript.Shell");
        if (wscript !== null) {
            wscript.SendKeys("{F11}");
        }
    }
}

function select_condition(){
	exp_json.conditions = collectorPapaParsed(exp_json.cond_array);

  exp_json.this_condition = exp_json.conditions.filter(function(row){
    return row.name == Study.get_vars.name;
  })[0];

  Study.activate_pipe();
}

function shuffleArray(array) { //by Laurens Holst on https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]; // eslint-disable-line no-param-reassign
    }
}

function shuffle_start_exp(){
  for(var i = 0; i < exp_json.parsed_proc.length; i++){
    if(exp_json.parsed_proc[i]["shuffle 1"] == ""){
      exp_json.parsed_proc[i]["shuffle 1"] = "off";
    }
  }
  if($("#shuffle_on_button").length == 0 || $("#shuffle_on_button").length == 1 && $("#shuffle_on_button").is(":hidden")){
		shuffle_array = {};
		exp_json.parsed_proc.forEach(function(row,index){
				var this_shuffle = row["shuffle 1"];
				if(typeof(shuffle_array[this_shuffle]) == "undefined"){
						shuffle_array[this_shuffle] = [index];
				} else {
						shuffle_array[this_shuffle].push(index);
				}
		});
		delete shuffle_array.off;
		Object.keys(shuffle_array).forEach(function(key){
				shuffleArray(shuffle_array[key]);
		});
		//apply shuffle to exp_json.parsed_proc
		new_proc = exp_json.parsed_proc.map(function(row,original_index){
				if(row["shuffle 1"] !== "off" & row["shuffle 1"] !== ""){
						this_shuffle = row["shuffle 1"];
						var this_pos = shuffle_array[this_shuffle].pop();
						return exp_json.parsed_proc[this_pos];
				}
				if(row["shuffle 1"] == "off"){
						return exp_json.parsed_proc[original_index];
				}
		});
		exp_json.parsed_proc = new_proc;
		exp_json.responses 	 = [];


	}
	exp_json.wait_to_proc	= false;
  Study.activate_pipe();
}

function start_restart(){
  if(window.localStorage.getItem("exp_json") !== null){

    bootbox.dialog({
  		title:"Restart?",
  		message: "It looks like you have already started this experiment, would you like to resume or restart?",
  		buttons: {
        local:{
          label: "Resume",
  				className: 'btn-primary',
  				callback: function(){
            exp_json = JSON.parse(window.localStorage.getItem("exp_json"));
            var participant_code = window.localStorage.getItem("username");
            var completion_code = window.localStorage.getItem("completion_code");
            var prehashed_code = window.localStorage.getItem("prehashed_code");
            $("#participant_code").val(participant_code);
            $("#completion_code").val(completion_code);
            $("#prehashed_code").val(prehashed_code);
            post_welcome(participant_code,false);
            Study.activate_pipe();
  				}
        },
  			start: {
  				label: "Restart",
  				className: 'btn-danger',
  				callback: function(){
            Study.activate_pipe();
  				}
  			},
  			cancel: {
  				label: "Cancel",
  				className: 'btn-secondary',
  				callback: function(){
  					//nada;
  				}
  			}
  		}
  	});
  } else {
    Study.activate_pipe();
  }
}

function start_study(){
  switch(Study.get_vars.platform){
    case "localhost":
      //expose...?
      eel.expose(python_gives_exp);
      function python_gives_exp(result){
        exp_json = result;
        Study.activate_pipe();
      }
      eel.ask_python_exp(Study.get_vars.location);
      break;
    case "github":
    case "preview":
      $.get("../User/Experiments/" + Study.get_vars.location + ".json",function(result){
        exp_json = result;
        Study.activate_pipe();
      });
      break;
    default:
      if(typeof(Study.get_vars.location) !== "undefined" && Study.get_vars.location !== ""){
        console.dir(Study.get_vars.location);
        if(Study.get_vars.location.indexOf("www.dropbox") !== -1){
          get_location = Study.get_vars.location.replace("www.","dl.");
        } else {
          get_location = Study.get_vars.location;
        }
        $.get(get_location,function(this_experiment){
          exp_json = JSON.parse(this_experiment);
          Study.activate_pipe();
        });
      }
      break;
  }
}

function write_trial_iframe(index){

	if(typeof(exp_json.parsed_proc[index]) == "undefined"){
		return null;
	}
	$("#experiment_div").append("<iframe class='trial_iframe' scrolling='no' frameBorder='0' id='trial"+index+"'></iframe>");
	this_proc = exp_json.parsed_proc[index];

	var post_trialtypes =  Object.keys(this_proc).filter(function(key) {
		return /trial type/.test(key);
	});
	trial_events = post_trialtypes.filter(function(post_trialtype){
    return this_proc[post_trialtype] !== "";
  });
	trial_iframe_code = '';
	for(var i = 0; i < trial_events.length; i++){ // write an iframe with the required number of sub_iframes
		if(this_proc[trial_events[i]] !== ""){
			trial_iframe_code += "<iframe class='post_iframe' style='height:100%; width:100%' frameBorder='0' id='post"+i+"'></iframe>";
		}
	}
	doc = document.getElementById('trial'+index).contentWindow.document;
	doc.open();
	doc.write(trial_iframe_code);
	doc.close();

	//CODE HERE TO DEAL WITH POST TRIAL TYPES
  for(var i = 0; i < trial_events.length; i++){

		var trial_content = Study.generate_trial(index,i); //exp_json.trial_no

    trial_content += "<button style='opacity:0; filter: alpha(opacity=0)' id='zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz'></button>";

		doc = document.getElementById('trial'+index).contentWindow.document.getElementById('post'+i).contentWindow;
		doc.document.open();
		doc.document.write(libraries + trial_content); //libraries + trial_content
		doc.document.close();

    //autoscroll to top of iframe (in case the trial runs over)
    doc.scrollTo(0,0);

		var no_images = (trial_content.match(/<img/g) || []).length;
		exp_json.uninitiated_stims.push(no_images);
		exp_json.uninitiated_stims_sum = exp_json.uninitiated_stims.reduce(function(acc,val){return acc + val });

		if(typeof(stim_interval) == "undefined"){
			//need code here to deal with "buffering" when there are no images.
			stim_interval = setInterval(function(){
				exp_json.initiated_stims = 0;
				for(var j = exp_json.trial_no; j < exp_json.trial_no + exp_json.this_condition.buffer; j++){
					if($("#trial"+j).contents().children().find("iframe").contents().children().find("img").prop("complete")){
					//if($("#trial"+j).contents().find('img').prop('complete') == true){
						exp_json.initiated_stims += $("#trial"+j).contents().children().find("iframe").contents().children().find("img").length;
					}
				}
				var completion = 100-exp_json.initiated_stims/exp_json.uninitiated_stims_sum;
				$("#stim_listing").css("width",completion+"%");
				if(completion == 100 | exp_json.uninitiated_stims_sum == 0){
					clearInterval(stim_interval);
					$("#loading_div").hide();
					$("#stim_progress").fadeOut(1000);
					if($("#calibrate_div").is(':visible') == false){
						$("#experiment_div").fadeIn(500);
					}
					if(exp_json.wait_to_proc){
						bootbox.alert("It looks like you have closed the window midway through an experiment. Please press OK when you are ready to resume the experiment!", function(){
							Study.start_post();
						});
					} else {
						Study.start_post();
					}
				}
			},10);
		}
	}

}


//////////////////////////////////////
// allow participant to save part way
//////////////////////////////////////

$(window).bind('keydown', function(event) {
	if (event.ctrlKey || event.metaKey) {
		switch (String.fromCharCode(event.which).toLowerCase()) {
			case 's':
				event.preventDefault();
				precrypted_data(exp_json,"What do you want to save this file as?");
			break;
		}
	}
});

//prevent closing without warning
window.onbeforeunload = function() {
  if(online_data_obj.finished_and_stored == false){
    precrypted_data(exp_json,"It looks like you're trying to leave the experiment before you're finished (or at least before the data has been e-mailed to the researcher. Please choose a filename to save your data as and e-mail it to the researcher. It should appear in your downloads folder.");
    return "Please do not try to refresh - you will have to restart if you do so.";
  }
};
$("body").css("text-align","center");
$("body").css("margin","auto");

//by qwerty at https://stackoverflow.com/questions/2116558/fastest-method-to-replace-all-instances-of-a-character-in-a-string
String.prototype.replaceAll = function(str1, str2, ignore){
  return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(ignore?"gi":"g")),(typeof(str2)=="string")?str2.replace(/\$/g,"$$$$"):str2);
}


Study.activate_pipe();
</script>
